{
  "kind": "build_request",
  "title": "Fix new user onboarding stuck after clicking Continue on role selection",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Fix profile creation so that a newly authenticated user (signing in with their own Internet Identity / Google-backed II) can successfully create an initial profile and proceed past the role selection step (police/ambulance) without requiring admin setup.",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "bro when another user gives their google account its not going past the continue where we will be selecting the interface whether police or ambulance"
        ]
      },
      "acceptanceCriteria": [
        "A brand-new user (principal not present in userProfiles) can submit the ProfileSetup form and the request succeeds (no trap).",
        "After successful profile creation, the app transitions out of ProfileSetup and renders AmbulanceInterface when role is ambulance, and PoliceInterface when role is police.",
        "Existing users can still update their name without breaking role-based routing.",
        "No admin token / secret URL parameter is required for regular users to complete onboarding."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Update backend authorization rules for basic user onboarding so that authenticated (non-anonymous) callers can read their own profile and create their initial profile, while keeping admin-only actions restricted (e.g., setting other usersâ€™ profiles, global deletes/reads).",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "not going past the continue"
        ]
      },
      "acceptanceCriteria": [
        "backend/main.mo no longer traps for initial profile creation for non-admin users; it allows creating a new profile for the caller.",
        "backend/main.mo still traps for admin-only methods when a non-admin calls them (no relaxation of admin-only operations).",
        "Anonymous callers (not authenticated) are still prevented from accessing profile and operational endpoints."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Improve the ProfileSetup UX to clearly display backend errors when saving the profile fails (e.g., unauthorized/trap), and ensure the Continue button returns to an actionable state after a failure.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "not going past the continue"
        ]
      },
      "acceptanceCriteria": [
        "If saving the profile fails, an English error message is shown in the ProfileSetup UI (not only console logging).",
        "After a failed save attempt, the user can retry without needing a page refresh (button not stuck in a loading/disabled state beyond the request duration).",
        "On success, the profile query is refreshed and the user is routed to the correct interface."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single Motoko actor in backend/main.mo (no additional backend services).",
    "Do not edit files under frontend/src/hooks/useInternetIdentity.ts(x) or frontend/src/hooks/useActor.ts (immutablePaths); fix behavior via backend changes and/or other frontend components/hooks.",
    "Use English for any user-facing UI text related to errors or onboarding."
  ],
  "nonGoals": [
    "Adding Google OAuth directly (the app uses Internet Identity; do not implement third-party auth integrations).",
    "Adding new roles beyond police and ambulance.",
    "Implementing custom domain configuration or deployment changes as part of this fix."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}