{
  "kind": "build_request",
  "title": "Redeploy and fix stuck loading screen with better error handling",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Update the app loading flow so the UI cannot remain indefinitely on the global \"Loading...\" screen; after a reasonable timeout, show a diagnostic state with clear messaging and recovery actions (e.g., retry fetching the user profile, re-create actor by invalidating React Query cache, and a hard reload option).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "redeploy it"
        ]
      },
      "acceptanceCriteria": [
        "When authentication initialization or profile fetch takes longer than the timeout, the app exits the spinner-only screen and shows a visible \"Still loading\" state with next-step actions.",
        "The recovery actions allow the user to retry without needing to redeploy (e.g., refetch profile query and clear/invalidate relevant React Query caches).",
        "If retries continue to fail, the diagnostic state remains usable and does not revert to an infinite spinner."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Surface actionable error details (in English) when actor creation or profile queries fail, including a user-friendly message and an expandable technical detail section (e.g., the React Query error message) to help debug cases where deployment is successful but the browser remains stuck.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "redeploy it"
        ]
      },
      "acceptanceCriteria": [
        "If the user profile query errors, the app renders an error state instead of appearing stuck loading.",
        "The error state includes a brief user-friendly explanation and a way to view the underlying error text for debugging.",
        "A retry control is present and triggers a refetch of the failed query."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Improve geolocation failure handling in Ambulance and Police interfaces to detect and clearly explain permission/policy-related failures (including cases like \"Geolocation has been disabled in this document by permissions policy\"), and provide clear next steps to the user.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "redeploy it"
        ]
      },
      "acceptanceCriteria": [
        "If geolocation fails with a permission/policy-related error, the UI shows a specific guidance message (not just the raw browser error).",
        "The rest of the page remains functional and does not get stuck in a perpetual \"Acquiring GPS location...\" state.",
        "The guidance text is in English."
      ]
    }
  ],
  "constraints": [
    "Do not modify files under frontend/src/hooks/useInternetIdentity.ts, frontend/src/hooks/useInternetIdentity.tsx, frontend/src/hooks/useActor.ts, frontend/src/main.tsx, or anything in frontend/src/components/ui (compose them instead).",
    "Maintain the existing single-actor Motoko backend architecture (no additional backend services)."
  ],
  "nonGoals": [
    "Do not add new authentication providers (Internet Identity only).",
    "Do not add real-time transport (no WebSockets/Socket.io).",
    "Do not introduce external databases or third-party hosting/deployment providers."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}