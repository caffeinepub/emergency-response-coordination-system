{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Police Command Center: show all ambulances, offline visibility, and correct contact association",
  "requirements": [
    {
      "id": "REQ-1",
      "summary": "Update Police Command Center to fetch and display all ambulance locations (not radius-limited) and apply optional radius filtering as a client-side view filter.",
      "acceptanceCriteria": [
        "When logged in as a police user, the Police Command Center displays all ambulances that have a stored location in the backend (not only those within POLICE_RADIUS_KM).",
        "Backend rejects the new “all ambulance locations” query for non-police/non-admin callers with an authorization trap consistent with existing patterns.",
        "The police map shows ambulance markers for the returned ambulances and does not show an empty state solely due to radius filtering."
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useQueries.ts",
          "operation": "modify",
          "description": "Add a police-oriented React Query hook that fetches all current ambulance locations (using the backend capability that returns all ambulance locations) and polls at LOCATION_UPDATE_INTERVAL. Ensure authorization failures are surfaced/handled similarly to existing patterns. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/pages/PoliceInterface.tsx",
          "operation": "modify",
          "description": "Wire the Police UI to use the new 'all ambulance locations' hook as the source of truth, and implement an optional client-side radius view filter (default can remain based on POLICE_RADIUS_KM) without preventing map/list from showing ambulances outside the radius when the filter is disabled. Update the list header/empty-state copy so it reflects the current filter mode. Verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-2",
      "summary": "Keep stale ambulances visible with an offline label and provide a toggle to hide/show offline ambulances across list and map.",
      "acceptanceCriteria": [
        "If an ambulance has not updated within the timeout window, it still appears in the list and on the map, and is visually marked as offline with a readable last-update age.",
        "Police users can toggle “Show offline ambulances” on/off; turning it off hides those stale ambulances from both list and map.",
        "The empty-state message (“No ambulances detected…”) only appears when there are truly no ambulances to show given the current toggle/filter settings."
      ],
      "file_operations": [
        {
          "path": "frontend/src/pages/PoliceInterface.tsx",
          "operation": "modify",
          "description": "Remove the hard filter that drops stale ambulance locations. Compute an 'isOffline' flag per ambulance based on last-update age; render offline styling and text like “Offline / Last update: Xs ago” in both the list item and marker label. Add a UI toggle state (default on) to show/hide offline ambulances and apply it consistently to both list and map marker generation. Ensure empty-state messaging only appears when no ambulances remain after applying current view toggles/filters. Verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-3",
      "summary": "Correctly associate ambulance contact details by ambulanceId rather than array index so contacts match the right marker and list item.",
      "acceptanceCriteria": [
        "For a given ambulanceId, the same ambulanceId is used to retrieve and render that ambulance’s contact info in both the list and the map marker label.",
        "Reordering of backend results (or differing order between location and contacts queries) does not cause contact information to appear under the wrong ambulance.",
        "If no contact is available for an ambulanceId, the UI shows “Unknown” (or existing fallback) only for that specific ambulance."
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useQueries.ts",
          "operation": "modify",
          "description": "Add a police-side data hook that retrieves contact/profile details keyed by ambulanceId (principal), returning a lookup map (e.g., by stringified principal) so the UI can render the correct name/phone for each ambulance regardless of ordering. Prefer using the backend capability to fetch a specific user's profile by principal to ensure stable association. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/pages/PoliceInterface.tsx",
          "operation": "modify",
          "description": "Replace index-based contact matching with ambulanceId-based lookup for both list rendering and map marker labels. Ensure missing profile/contact info only affects the corresponding ambulance (showing 'Unknown' fallback) and does not shift other ambulances' contact details. Verify the component's usage instructions before implementing."
        }
      ]
    }
  ]
}