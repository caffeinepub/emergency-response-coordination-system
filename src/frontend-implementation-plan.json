{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Unblock new-user onboarding after role selection (frontend)",
  "requirements": [
    {
      "id": "REQ-1",
      "summary": "Ensure profile creation completion reliably transitions the authenticated user out of ProfileSetup into the correct role interface without any admin token flow.",
      "acceptanceCriteria": [
        "A brand-new user (principal not present in userProfiles) can submit the ProfileSetup form and the request succeeds (no trap).",
        "After successful profile creation, the app transitions out of ProfileSetup and renders AmbulanceInterface when role is ambulance, and PoliceInterface when role is police.",
        "Existing users can still update their name without breaking role-based routing.",
        "No admin token / secret URL parameter is required for regular users to complete onboarding."
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useQueries.ts",
          "operation": "modify",
          "description": "Harden the onboarding profile save flow by ensuring a successful save triggers an immediate refresh of the ['currentUserProfile'] query (invalidate + refetch) so App.tsx can reliably transition to the correct role interface. Use the selected authorization component’s frontend guidance for calling getCallerUserProfile/saveCallerUserProfile and handling trap/unauthorized errors gracefully; verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/App.tsx",
          "operation": "modify",
          "description": "Tighten role-based routing/state transitions after profile creation by relying on the refreshed current user profile (and not any URL/session token mechanisms) to decide between rendering ProfileSetup vs AmbulanceInterface vs PoliceInterface. Use the selected authorization component’s frontend guidance on profile setup gating and avoiding profile-setup flashes; verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-3",
      "summary": "Display actionable backend error messages in ProfileSetup when saving fails and ensure the Continue button can be used again immediately after a failed attempt.",
      "acceptanceCriteria": [
        "If saving the profile fails, an English error message is shown in the ProfileSetup UI (not only console logging).",
        "After a failed save attempt, the user can retry without needing a page refresh (button not stuck in a loading/disabled state beyond the request duration).",
        "On success, the profile query is refreshed and the user is routed to the correct interface."
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/ProfileSetup.tsx",
          "operation": "modify",
          "description": "Add local UI error state to render an English error message when saveCallerUserProfile fails (e.g., unauthorized/trap), clear the error on retry, and ensure the loading/disabled state is tied only to the in-flight mutation so the Continue button becomes actionable again after failure. Use the selected authorization component’s frontend error-handling guidance for trap/unauthorized messages; verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/hooks/useQueries.ts",
          "operation": "modify",
          "description": "Expose/save error information cleanly from the save profile mutation (e.g., via thrown Error message) and ensure onSuccess refreshes the current profile query so ProfileSetup exits automatically after a successful retry. Use the selected authorization component’s frontend guidance for handling authorization failures gracefully; verify the component's usage instructions before implementing."
        }
      ]
    }
  ]
}